@model List<IconConfigurationDTO>
@{
    var videoItems = Model
        .SelectMany(m => m.IconConfigurationAttachments)
        .Select(a => new
        {
            src = a.AttachmentTransaction.FilePath,
            duration = a.IconConfiguration.VideoDisplaySec
        })
        .ToList();

    var a = videoItems;

}
<div class="video-container1" style="position: relative; width: 100%; height: 100vh; overflow: hidden; background: unset;">
    <video autoplay muted loop playsinline class="bg-video active" id="video1" preload="auto" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 1s ease-in-out; opacity: 1;"></video>
    <video muted playsinline loop class="bg-video" id="video2" preload="auto" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 1s ease-in-out; opacity: 0;"></video>
</div>

<script>
    const videoList = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(videoItems));
    const players = [document.getElementById("video1"), document.getElementById("video2")];

    let currentIndex = 0;
    let activePlayerIndex = 0;
    let timer = null;

    function playNextVideo() {
        const currentPlayer = players[activePlayerIndex];
        activePlayerIndex = 1 - activePlayerIndex;
        const nextPlayer = players[activePlayerIndex];

        const videoData = videoList[currentIndex];

        // Set source
        nextPlayer.src = videoData.src;

        // ALWAYS keep loop false.
        // We want the JavaScript timer below to handle the "looping"
        // so we can jump from the last video back to the 3rd one.
        nextPlayer.loop = false;

        nextPlayer.load();

        nextPlayer.oncanplaythrough = () => {
            nextPlayer.play();

            // Cross-fade
            nextPlayer.style.opacity = "1";
            currentPlayer.style.opacity = "0";

            clearTimeout(timer);

            timer = setTimeout(() => {
                // INCREMENT LOGIC
                if (currentIndex < videoList.length - 1) {
                    // Move to the next video in the list
                    currentIndex++;
                } else {
                    // We reached the last video.
                    // If there are 3 or more videos, jump back to index 2 (the 3rd video).
                    // If there are only 2 videos total, stay on the last one or jump to 0
                    // depending on your preference, but usually index 2 starts the "loop".
                    currentIndex = (videoList.length > 2) ? 2 : currentIndex;
                }

                playNextVideo();
            }, videoData.duration * 1000);

            nextPlayer.oncanplaythrough = null;
        };
    }

    // Initial Start
    if (videoList && videoList.length > 0) {
        playNextVideo();
    }

    // Existing safety handlers
    players.forEach(p => {
        p.addEventListener('contextmenu', e => e.preventDefault());
    });

    document.addEventListener("visibilitychange", () => {
        const activePlayer = players[activePlayerIndex];
        if (document.hidden) activePlayer.pause();
        else activePlayer.play();
    });
</script>