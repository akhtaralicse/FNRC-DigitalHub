@model List<IconConfigurationDTO>
@{
    var videoItems = Model
        .SelectMany(m => m.IconConfigurationAttachments)
        .Select(a => new
        {
            src = a.AttachmentTransaction.FilePath,
            duration = a.IconConfiguration.VideoDisplaySec
        })
        .ToList();

    var a = videoItems;

}
<div class="video-container1" style="position: relative; width: 100%; height: 100vh; overflow: hidden; background: unset;">
    <video autoplay muted loop playsinline class="bg-video active" id="video1" preload="auto" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 1s ease-in-out; opacity: 1;"></video>
    <video muted playsinline loop class="bg-video" id="video2" preload="auto" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 1s ease-in-out; opacity: 0;"></video>
</div>

<script>
    const videoList = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(videoItems));
    const players = [document.getElementById("video1"), document.getElementById("video2")];

    let currentIndex = 0;
    let activePlayerIndex = 0;
    let timer = null;

    function playNextVideo() {
        const currentPlayer = players[activePlayerIndex];
        activePlayerIndex = 1 - activePlayerIndex;
        const nextPlayer = players[activePlayerIndex];

        const videoData = videoList[currentIndex];

        // 1. Set source
        nextPlayer.src = videoData.src;

        // 2. Logic: Disable loop for the first two videos (index 0 and 1)
        // Enable loop for everything from the 3rd video (index 2) onwards
        if (currentIndex < 2) {
            nextPlayer.loop = false;
        } else {
            nextPlayer.loop = true;
        }

        nextPlayer.load();

        nextPlayer.oncanplaythrough = () => {
            nextPlayer.play();

            // Cross-fade
            nextPlayer.style.opacity = "1";
            currentPlayer.style.opacity = "0";

            clearTimeout(timer);

            // 3. Determine if we should move to the next video
            // If it's one of the first two, we move forward when duration ends.
            // If we are at the end of the list, it continues looping the last video
            // because of nextPlayer.loop = true.
            timer = setTimeout(() => {
                // If it's the first two videos, OR if we've reached the looping section
                if (currentIndex < videoList.length - 1 || currentIndex < 2) {
                    currentIndex = (currentIndex + 1) % videoList.length;

                    // If we just finished video 2 (index 1), we move to the rest
                    // which will now loop.
                    playNextVideo();
                }
            }, videoData.duration * 1000);

            nextPlayer.oncanplaythrough = null;
        };
    }

    // Initial Start
    if (videoList && videoList.length > 0) {
        playNextVideo();
    }

    // Existing safety handlers
    players.forEach(p => {
        p.addEventListener('contextmenu', e => e.preventDefault());
    });

    document.addEventListener("visibilitychange", () => {
        const activePlayer = players[activePlayerIndex];
        if (document.hidden) activePlayer.pause();
        else activePlayer.play();
    });
</script>