@model List<IconConfigurationDTO> 
@{
    var lang = loc.localizer["lang"];
    Layout = "~/Views/Shared/_Layout_Admin.cshtml";
}
<div class="container gallery">
    <div class="row">

        <form id="galleryForm" method="post" enctype="multipart/form-data" asp-antiforgery="true">
            <div class="container">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h5 class="m-0 font-weight-bold text-primary">@(loc.localizer["IconManagement"])</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                         
                            <div class="col-lg-4 mb-4">
                                <div class="card border-left-primary shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-3">
                                            @(loc.localizer["IconFile"])
                                        </div>
                                        <div class="drop_box p-4 border rounded bg-light text-center">
                                            <i class="fas fa-image fa-3x text-gray-400 mb-3 mx-2"></i>
                                            <h5>@(loc.localizer["UploadIcon"])</h5>
                                            <p class="text-muted small">@(loc.localizer["SupportedFiles"]) PNG, JPG</p>
                                            <input type="file" class="attach-input" id="fileID" accept="image/*,.svg" style="display: none;" required>
                                            <button type="button" class="btn btn-primary attach-btn">
                                                <i class="fas fa-upload mr-2 mx-2"></i>@(loc.localizer["ChooseFile"])
                                            </button>
                                            <div id="fileListUpdate"></div>
                                            <div id="fileList" class="mt-3"></div>
                                        </div>
                                    </div>
                                </div>
                            </div> 
                           
                            <div class="col-lg-8 mb-4">
                                <div class="card border-left-success shadow h-100 py-2">
                                    <div class="card-body">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-3">
                                            @(loc.localizer["IconDetails"])
                                        </div>
                                        <input type="hidden" name="Id" id="Id" value="" />
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="NameEn" class="form-label">@(loc.localizer["NameEn"])</label>
                                                <input type="text" class="form-control" name="NameEn" id="NameEn" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="NameAr" class="form-label">@(loc.localizer["NameAr"])</label>
                                                <input type="text" class="form-control" name="NameAr" id="NameAr" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="URL" class="form-label">@(loc.localizer["URL"])</label>
                                                <input type="url" class="form-control" name="URL" id="URL" placeholder="https://example.com">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="OrderNo" class="form-label">@(loc.localizer["OrderNo"])</label>
                                                <input type="number" class="form-control" name="OrderNo" id="OrderNo" min="0" required>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label for="DescriptionEn" class="form-label">@(loc.localizer["DescriptionEn"])</label>
                                                <textarea class="form-control" name="DescriptionEn" id="DescriptionEn" rows="3"></textarea>
                                            </div>
                                            <div class="col-md-12 mb-3">
                                                <label for="DescriptionAr" class="form-label">@(loc.localizer["DescriptionAr"])</label>
                                                <textarea class="form-control" name="DescriptionAr" id="DescriptionAr" rows="3"></textarea>
                                            </div>
                                        </div>


                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="row">
                            <div class="col-12 text-center mt-4">
                                <div class="d-flex justify-content-center">
                                    <button type="button" id="submitDiv" class="btn btn-success btn-lg px-5">
                                        <i class="fas fa-save mr-2 mx-2"></i>
                                        <span class="AddNew1">@(loc.localizer["Save"])</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>


    </div>
</div>

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">@loc.localizer["IconManagement"]</h1>
      @*   <a href="#" onclick="openNewApp('/admin/iconsetting')" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>@loc.localizer["AddNewIcon"]
        </a> *@
    </div>

    <div class="card">
        
        <div class="card-body p-0">
            @if (Model.Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>@loc.localizer["Icon"]</th>
                                <th>@loc.localizer["Name"]</th>
                                <th>@loc.localizer["Description"]</th>
                                <th>@loc.localizer["URL"]</th>
                                <th>@loc.localizer["Order"]</th>
                                <th>@loc.localizer["Actions"]</th>
                            </tr>
                        </thead>
                        <tbody id="iconsTableBody">
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        <img width="50" src="@(item.IconConfigurationAttachments.Count>0? item.IconConfigurationAttachments.First().AttachmentTransaction.ThumbPath:"")" alt="" class="icon-preview" />
                                    </td>
                                    <td>
                                        <div>@item.NameEn</div>
                                        <small class="text-muted">@item.NameAr</small>
                                    </td>
                                    <td width="40%">
                                        <div style="font-size:11px">@item.DescriptionEn</div>
                                        <small class="text-muted" style="font-size:11px">@item.DescriptionAr</small>
                                    </td>
                                    <td>
                                        <a href="@item.URL" target="_blank" class="text-truncate d-block" style="max-width: 150px;">
                                            @item.URL
                                        </a>
                                    </td>
                                    <td>@item.OrderNo</td>

                                    <td>
                                        <div class="action-buttons">

                                            <button class="btn btn-sm btn-outline-primary" onclick="LoadUpdateRecord('@(item.Id)')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('@(item.Id)')">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div id="emptyState" class="empty-state d-none">
                    <i class="fas fa-folder-open"></i>
                    <h4 class="mt-3">@loc.localizer["NoDataFound"]</h4>
                </div>
            }
        </div>
    </div>


</div>


@section scripts {
    <script>
        let selectedFiles = [];
        const button = document.querySelector(".attach-btn");
        const input = document.querySelector(".attach-input");
        let file;
        button.onclick = () => {
            input.click();
        };
        document.getElementById('submitDiv').addEventListener('click', function (e) {
            e.preventDefault();
            var isUpdate = $('#galleryForm').find('input[name="Id"]').val() != "";

            if (selectedFiles.length === 0 && !isUpdate) {
                Swal.fire("warning", "Please select at least one file.", "warning");
                return;
            }

            var formData = new FormData($('#galleryForm')[0]);
            formData.append('IconType', 'Icon');
            for (var i = 0; i < selectedFiles.length; i++) {
                formData.append('files', selectedFiles[i]);
            }

             var url = isUpdate ? '/admin/UpdateIcons' : '/admin/AddIcons';
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        SuccessWithCallBack('@(loc.localizer["Success"])', '@(loc.localizer["Success"])', '@lang', window.location.href)

                    } else {
                        Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                    }
                },
                error: function (xhr, status, error) {
                    Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                }
            });
        });

         function LoadUpdateRecord(id) {
       
           $.ajax({
            url: '/admin/GetIconById?id='+id,
            type: 'get',
            data: {},
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.success) {
                    var msg = response.message[0];
                        //console.log(response.message);
                        $('#galleryForm').find('input[name="NameAr"]').val(msg.NameAr);
                        $('#galleryForm').find('input[name="NameEn"]').val(msg.NameEn);
                        $('#galleryForm').find('textarea[name="DescriptionAr"]').val(msg.DescriptionAr);
                        $('#galleryForm').find('textarea[name="DescriptionEn"]').val(msg.DescriptionEn);
                        $('#galleryForm').find('input[name="URL"]').val(msg.URL);
                        $('#galleryForm').find('input[name="OrderNo"]').val(msg.OrderNo);
                        $('#galleryForm').find('input[name="Id"]').val(msg.Id);
                        $('#submitDiv').html('@loc.localizer["Update"]')
                        $('.AddNew1').html('@loc.localizer["Update"]')
                        var html ='';
                            msg.IconConfigurationAttachments.forEach(x =>
                            {
                                html += `<a class=""  id="image_${x.Id}" style="position: relative;"  href="javascript:void(0)" onclick="deleteImage_Js('${x.Id}')">
                                            <span><i class="fa fa-times delete-icon"></i></span>
                                            <img width="60px" src="${x.AttachmentTransaction.ThumbPath}" alt="fnrc">
                                        </a>`;

                            })
                            $('#fileListUpdate').html(html);
                            window.scroll(0,0);
                        }
                    },
                    error: function (xhr, status, error) {
                        Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                    }
                });
        }
           function deleteRecord(id) {
            DeleteWithCallBack('@lang', () => {
                $.ajax({
                    url: '/admin/DeleteIcon?id=' + id,
                    type: 'POST',
                    data: {},
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            SuccessWithCallBack('@(loc.localizer["Success"])', '@(loc.localizer["Success"])', '@lang', window.location.href)

                        } else {
                            Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                        }
                    },
                    error: function (xhr, status, error) {
                        Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                    }
                });
            })
        }
        function deleteImage_Js(id) {

            DeleteWithCallBack('@lang', () => {
                $.ajax({
                    url: '/admin/DeleteImage?id=' + id,
                    type: 'POST',
                    data: {},
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            $('#image_' + id).remove();
                        } else {
                            Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                        }
                    },
                    error: function (xhr, status, error) {
                        Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                    }
                });
            })
        }
        document.getElementById('fileID').addEventListener('change', function () {
            if (!validateFileSize(this)) {
                return false;
            }

            var files = this.files;
            var fileNames = '';

            for (var i = 0; i < files.length; i++) {
                let file = files[i];
                fileNames += files[i].name + '<br>';
                if (file.name.length > 20) {
                    const truncatedName = truncateFileName(file.name, 20);
                    file = new File([file], truncatedName, { type: file.type });
                }
                selectedFiles.push(file);
            }
            updateFileList();
        });
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'fileItem';

                const fileName = document.createElement('span');
                fileName.textContent = file.name;

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<i class="fa fa-times"></i>';
                deleteButton.type = 'button';
                deleteButton.addEventListener('click', function () {
                    selectedFiles.splice(index, 1);
                    updateFileList();
                });

                fileItem.appendChild(fileName);
                fileItem.appendChild(deleteButton);
                fileList.appendChild(fileItem);
            });
        }
        function deleteImage(id) {

            DeleteWithCallBack('@lang', () => {
                $.ajax({
                    url: '/admin/DeleteImage?fileId=' + id,
                    type: 'POST',
                    data: {},
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            SuccessWithCallBack('@(loc.localizer["Success"])', '@(loc.localizer["Success"])', '@lang', window.location.href)

                        } else {
                            Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                        }
                    },
                    error: function (xhr, status, error) {
                        Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                    }
                });
            })
        }
    </script>
}


