@model List<NotificationConfigurationDTO>
@{
    ViewData["Title"] = "Home Page";
    Layout = "~/Views/Shared/_Layout_Admin.cshtml";
    var lang = loc.localizer["lang"];
}

<div class="container">
    <div class="form-container">
        <h2 class="text-center mb-4">
            <i class="bi bi-bell-fill"></i> @loc.localizer["AnnouncementConfiguration"]
        </h2>

        <form id="galleryForm" method="post" enctype="multipart/form-data" asp-antiforgery="true">

            <div class="form-section">
                <h5><i class="bi bi-info-circle"></i> Basic Information</h5>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <input type="hidden" name="Id" id="Id" value="" />
                        <label for="title" class="form-label required">@loc.localizer["Title"] @loc.localizer["ArabicLang"]</label>
                        <input type="text" 
                               class="form-control"
                               id="TitleAr"
                               name="TitleAr"
                               placeholder="Title Ar"
                               required
                               maxlength="100">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="title" class="form-label required">@loc.localizer["Title"] @loc.localizer["EnglishLang"]</label>
                        <input type="text"
                               class="form-control"
                               id="TitleEn"
                               name="TitleEn"
                               placeholder="Title En"
                               required
                               maxlength="100">

                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="message" class="form-label required">@loc.localizer["Message"] @loc.localizer["ArabicLang"]</label>
                        <textarea class="form-control"
                                  id="MessageAr"
                                  name="MessageAr"
                                  rows="3"
                                  placeholder=""
                                  required
                                  maxlength="500"></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="message" class="form-label required">@loc.localizer["Message"] @loc.localizer["EnglishLang"]</label>
                        <textarea class="form-control"
                                  id="MessageEn"
                                  name="MessageEn"
                                  rows="3"
                                  placeholder=""
                                  required
                                  maxlength="500"></textarea>
                    </div>
                </div>

            </div>

            <div class="form-section">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label for="startDate" class="form-label">@loc.localizer["StartDate"]</label>
                            <input type="datetime-local"
                                   class="form-control"
                                   id="StartDate"
                                   name="StartDate">

                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label for="endDate" class="form-label">@loc.localizer["EndDate"]</label>
                            <input type="datetime-local"
                                   class="form-control"
                                   id="EndDate"
                                   name="EndDate">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="row">
                    <div class="mb-3 col-md-4">
                        <label for="actionUrl" class="form-label">@loc.localizer["ActionURL"]</label>
                        <input type="url"
                               class="form-control"
                               id="ActionUrl"
                               name="ActionUrl"
                               placeholder="https://example.com/action">
                    </div>

                    <div class="mb-3 col-md-4">
                        <label for="actionText" class="form-label">@loc.localizer["ActionText"] @loc.localizer["ArabicLang"]</label>
                        <input type="text"
                               class="form-control"
                               id="ActionTextAr"
                               name="ActionTextAr"
                               placeholder="Learn More"
                               maxlength="50">
                    </div>
                    <div class="mb-3 col-md-4">
                        <label for="actionText" class="form-label">@loc.localizer["ActionText"] @loc.localizer["EnglishLang"]</label>
                        <input type="text"
                               class="form-control"
                               id="ActionTextEn"
                               name="ActionTextEn"
                               placeholder="Learn More"
                               maxlength="50">
                    </div>
                </div>
            </div>

            <div class="form-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="button" id="submitDiv" class="btn btn-success">
                              <span class="AddNew1">@(loc.localizer["Save"])</span>
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

</div>
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="card">
            <div class="card-body p-0">
                @if (Model.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>@loc.localizer["Name"]</th>
                                    <th>@loc.localizer["Description"]</th>
                                    <th>@loc.localizer["Date"]</th>
                                    <th>@loc.localizer["URL"]</th>
                                    <th>@loc.localizer["Actions"]</th>
                                </tr>
                            </thead>
                            <tbody id="iconsTableBody">
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>
                                            <div>@item.TitleEn</div>
                                            <small class="text-muted">@item.TitleAr</small>
                                        </td>
                                        <td width="40%">
                                            <div style="font-size:11px">@item.MessageEn</div>
                                            <small class="text-muted" style="font-size:11px">@item.MessageAr</small>
                                        </td>
                                        <td>
                                            <div>@item.StartDate</div>
                                            <div>@item.EndDate</div>
                                        </td>
                                        <td>
                                            <div>@item.ActionUrl</div>
                                            <small class="text-muted">@item.ActionTextEn</small>
                                            <small class="text-muted">@item.ActionTextAr</small>
                                        </td>

                                        <td>
                                            @* @if (item.StartDate <= DateTime.Now && item.EndDate >= DateTime.Now)
                                            { *@
                                                <div class="action-buttons">
                                                    <button class="btn btn-sm btn-outline-primary" onclick="LoadUpdateRecord('@(item.Id)')">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('@(item.Id)')">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                </div>
                                            @* } *@
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div id="emptyState" class="empty-state d-none">
                        <i class="fas fa-folder-open"></i>
                        <h4 class="mt-3">@loc.localizer["NoDataFound"]</h4>
                    </div>
                }
            </div>
        </div>

    </div>
</div>

<script>
    let selectedFiles = [];
    const button = document.querySelector(".attach-btn");
    const input  = document.querySelector(".attach-input");
    let file;
    // button.onclick = () => {
    //     input.click();
    // };
    document.getElementById('submitDiv').addEventListener('click', function (e) {
        e.preventDefault();
        var isUpdate = $('#galleryForm').find('input[name="Id"]').val() != "";

        if (selectedFiles.length === 0 && !isUpdate) {
            Swal.fire("warning", "Please select at least one file.", "warning");
            return;
        }

        var formData = new FormData($('#galleryForm')[0]);
        formData.append('IconType', 'Icon');
        for (var i = 0; i < selectedFiles.length; i++) {
            formData.append('files', selectedFiles[i]);
        }

         var url = isUpdate ? '/admin/UpdateNotification' : '/admin/AddNotification';
        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.success) {
                    SuccessWithCallBack('@(loc.localizer["Success"])', '@(loc.localizer["Success"])', '@lang', window.location.href)

                } else {
                    Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                }
            },
            error: function (xhr, status, error) {
                Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
            }
        });
    });

    // document.getElementById('fileID').addEventListener('change', function () {
    //         if (!validateFileSize(this)) {
    //             return false;
    //         }

    //         var files = this.files;
    //         var fileNames = '';

    //         for (var i = 0; i < files.length; i++) {
    //             let file = files[i];
    //             fileNames += files[i].name + '<br>';
    //             if (file.name.length > 20) {
    //                 const truncatedName = truncateFileName(file.name, 20);
    //                 file = new File([file], truncatedName, { type: file.type });
    //             }
    //             selectedFiles.push(file);
    //         }
    //         updateFileList();
    //     });
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'fileItem';

                const fileName = document.createElement('span');
                fileName.textContent = file.name;

                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '<i class="fa fa-times"></i>';
                deleteButton.type = 'button';
                deleteButton.addEventListener('click', function () {
                    selectedFiles.splice(index, 1);
                    updateFileList();
                });

                fileItem.appendChild(fileName);
                fileItem.appendChild(deleteButton);
                fileList.appendChild(fileItem);
            });
        }
          function LoadUpdateRecord(id) {
       
           $.ajax({
            url: '/admin/GetNotificationById?id='+id,
            type: 'get',
            data: {},
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.success) {
                    var msg = response.message;
                        console.log(response.message);
                        $('#galleryForm').find('input[name="TitleAr"]').val(msg.TitleAr);
                        $('#galleryForm').find('input[name="TitleEn"]').val(msg.TitleEn);
                        $('#galleryForm').find('textarea[name="MessageAr"]').val(msg.MessageAr);
                        $('#galleryForm').find('textarea[name="MessageEn"]').val(msg.MessageEn);
                        $('#galleryForm').find('textarea[name="StartDate"]').val(msg.StartDate);
                        $('#galleryForm').find('textarea[name="EndDate"]').val(msg.EndDate);

                        $('#galleryForm').find('input[name="ActionURL"]').val(msg.ActionURL);
                        $('#galleryForm').find('input[name="ActionTextAr"]').val(msg.ActionTextAr);
                        $('#galleryForm').find('input[name="ActionTextEn"]').val(msg.ActionTextEn); 
                        $('#galleryForm').find('input[name="Id"]').val(msg.Id);
                        $('#submitDiv').html('@loc.localizer["Update"]')
                        $('.AddNew1').html('@loc.localizer["Update"]')
                        var html ='';
                            // msg.IconConfigurationAttachments.forEach(x =>
                            // {
                            //     html += `<a class=""  id="image_${x.Id}" style="position: relative;"  href="javascript:void(0)" onclick="deleteImage_Js('${x.Id}')">
                            //                 <span><i class="fa fa-times delete-icon"></i></span>
                            //                 <img width="60px" src="${x.AttachmentTransaction.ThumbPath}" alt="fnrc">
                            //             </a>`;

                            // })
                           // $('#fileListUpdate').html(html);
                            window.scroll(0,0);
                        }
                    },
                    error: function (xhr, status, error) {
                        Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                    }
                });
        }
        function deleteRecord(id) {
            DeleteWithCallBack('@lang', () => {
                $.ajax({
                    url: '/admin/DeleteNotification?id=' + id,
                    type: 'POST',
                    data: {},
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.success) {
                            SuccessWithCallBack('@(loc.localizer["Success"])', '@(loc.localizer["Success"])', '@lang', window.location.href)

                        } else {
                            Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                        }
                    },
                    error: function (xhr, status, error) {
                        Swal.fire('@(loc.localizer["Error"])', '@(loc.localizer["SomethingWentWrong"])', "error");
                    }
                });
            })
        }

</script>